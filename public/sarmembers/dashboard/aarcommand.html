<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAR Command Review</title>
    <link rel="stylesheet" href="styles.css"> <!-- Link to your CSS -->
    
    <!-- Include SheetJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script type="module">
        // Import Firebase functions from the CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCz1kIH5hT_15pWT9rf5JqJhexK76qpRE",
            authDomain: "hrnf-srt.firebaseapp.com",
            projectId: "hrnf-srt",
            storageBucket: "hrnf-srt.appspot.com",
            messagingSenderId: "748926279394",
            appId: "1:748926279394:web:1303b9000361b1d51808bb",
            measurementId: "G-5PCZE3S5N5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Fetch reports and display them
        window.fetchReports = async () => {
            const reportList = document.getElementById("reportList");
            reportList.innerHTML = ""; // Clear previous results

            const querySnapshot = await getDocs(collection(db, "reports"));
            querySnapshot.forEach((doc) => {
                const reportData = doc.data();
                const reportElement = document.createElement("div");
                reportElement.className = "report-item";
                reportElement.innerHTML = `
                    <h3>${reportData.title}</h3>
                    <button onclick="viewReport('${doc.id}')">View Report</button>
                `;
                reportList.appendChild(reportElement);
            });
        };

        // View report
        window.viewReport = async (reportId) => {
            const reportDoc = await doc(db, "reports", reportId).get();
            const reportData = reportDoc.data();
            const readerPane = document.getElementById("readerPane");
            readerPane.innerHTML = `
                <h2>${reportData.title}</h2>
                <p><strong>Submitted By:</strong> ${reportData.teamLead}</p>
                <p><strong>Incident Overview:</strong> ${reportData.incidentOverview}</p>
                <p><strong>Health & Safety Issues:</strong> ${reportData.hsIssues}</p>
                <p><strong>Casualties:</strong> ${reportData.casualties}</p>
                <p><strong>Communication Issues:</strong> ${reportData.communicationIssues}</p>
                <p><strong>Other Issues:</strong> ${reportData.otherIssues}</p>
                <p><strong>Future Suggestions:</strong> ${reportData.futureSuggestions}</p>
                <p><strong>Persons of Merit:</strong> ${reportData.personsOfMerit}</p>
                <button onclick="downloadReport('${doc.id}')">Download</button>
                <button onclick="deleteReport('${doc.id}')">Delete</button>
            `;
        };

        // Download report
        window.downloadReport = async (reportId) => {
            const reportDoc = await doc(db, "reports", reportId).get();
            const reportData = reportDoc.data();

            if (reportData) {
                // Create a workbook and a worksheet
                const wb = XLSX.utils.book_new();
                const wsData = [
                    ["Title", "Submitted By", "Incident Overview", "H&S Issues", "Casualties", "Communication Issues", "Other Issues", "Future Suggestions", "Persons of Merit"],
                    [
                        reportData.title,
                        reportData.teamLead,
                        reportData.incidentOverview,
                        reportData.hsIssues,
                        reportData.casualties,
                        reportData.communicationIssues,
                        reportData.otherIssues,
                        reportData.futureSuggestions,
                        reportData.personsOfMerit,
                    ]
                ];
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, "Report");

                // Generate a downloadable file
                const filename = `${reportData.title.replace(/ /g, "_")}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, filename);
            } else {
                alert("Error: Report not found.");
            }
        };

        // Delete report
        window.deleteReport = async (reportId) => {
            if (confirm("Are you sure you want to delete this report?")) {
                await deleteDoc(doc(db, "reports", reportId));
                alert("Report deleted successfully.");
                fetchReports(); // Refresh the report list
                document.getElementById("readerPane").innerHTML = ""; // Clear the reader pane
            }
        };

        // Call fetchReports on page load
        fetchReports();
    </script>

    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
        }
        
        header {
            width: 100%;
            background-color: rgba(51, 51, 51, 0.8);
            color: white;
            padding: 20px 0;
            text-align: center;
        }

        /* Sidebar styles */
        .sidebar {
            width: 250px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding: 10px;
            overflow-y: auto; /* Allow scrolling if content overflows */
        }

        .report-item {
            border-bottom: 1px solid #ccc;
            padding: 10px 0;
        }

        .report-item h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        /* Reader pane styles */
        .reader-pane {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            margin-left: 10px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        /* Footer styling */
        footer {
            background-color: #333; /* Footer background color */
            color: white;
            text-align: center;
            padding: 20px 0;
            width: 100%;
            position: absolute; /* Keep it at the bottom */
            bottom: 0;
        }

        /* Button styling */
        button {
            padding: 10px 15px;
            background-color: #e94307;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        /* Button hover effect */
        button:hover {
            background-color: #b63101;
        }
    </style>
</head>
<body>
    <header>
        <h1>Command Review Page</h1>
    </header>

    <div class="container">
        <div class="sidebar" id="reportList">
            <h2>Reports</h2>
            <!-- Reports will be dynamically loaded here -->
        </div>
        <div class="reader-pane" id="readerPane">
            <h2>Select a report to view</h2>
            <!-- Report details will be displayed here -->
        </div>
    </div>

    <footer>
        <p>&copy; 2024 Your Organization</p>
    </footer>
</body>
</html>
