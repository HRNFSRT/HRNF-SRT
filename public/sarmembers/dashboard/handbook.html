<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handbook - Highrock National Forest Search & Rescue</title>
    
    <!-- Link to CSS Styles -->
    <link rel="stylesheet" href="styles.css">

    <!-- PDF.js Library from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

    <!-- Firebase Integration -->
    <script type="module">
        // Import Firebase functions from the CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-storage.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCz1kIH5hT_15pWT9rf5JqJhexK76qpRE",
            authDomain: "hrnf-srt.firebaseapp.com",
            projectId: "hrnf-srt",
            storageBucket: "hrnf-srt.appspot.com",
            messagingSenderId: "748926279394",
            appId: "1:748926279394:web:1303b9000361b1d51808bb",
            measurementId: "G-5PCZE3S5N5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Initialize Auth
        const storage = getStorage(app); // Initialize Storage

        // Load PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        // Load PDF from Firebase and render with PDF.js
        async function loadPDF() {
            try {
                const pdfRef = ref(storage, 'HRNF S&R Handbook V2 (1).pdf'); // Reference to the PDF
                const url = await getDownloadURL(pdfRef); // Get the download URL for the PDF
                const pdf = await pdfjsLib.getDocument(url).promise; // Load PDF
                renderPDF(pdf); // Render the PDF
                extractHeadings(pdf); // Extract headings for the sidebar
            } catch (error) {
                console.error("Error loading PDF:", error);
            }
        }

        // Render the PDF using PDF.js
        async function renderPDF(pdf) {
            const pdfViewerContainer = document.getElementById('pdfViewerContainer');
            pdfViewerContainer.innerHTML = ''; // Clear the container before rendering

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 }); // Adjust scale as necessary

                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page';
                const context = canvas.getContext('2d');

                // Set the canvas dimensions
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport,
                };
                await page.render(renderContext);
                pdfViewerContainer.appendChild(canvas); // Append the canvas to the viewer
            }
        }

        // RGB color mapping for headings
        const headingColors = {
            'Heading 1': [5, 110, 58],   // RGB(5,110,58)
            'Heading 2': [255, 51, 0],    // RGB(255,51,0)
            'Heading 3': [16, 42, 235],    // RGB(16,42,235)
            'Heading 4': [18, 79, 26],     // RGB(18,79,26)
            'Heading 5': [166, 6, 12]      // RGB(166,6,12)
        };

        // Function to check if two RGB colors are equal
        function colorsMatch(color1, color2) {
            return color1[0] === color2[0] && color1[1] === color2[1] && color1[2] === color2[2];
        }

        // Extract headings from the PDF based on text color
        async function extractHeadings(pdf) {
            const sidebarList = document.getElementById('sidebarList');
            const headingSet = new Set(); // To keep track of added headings

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const textItems = textContent.items;

                textItems.forEach(item => {
                    const text = item.str.trim();
                    const color = item.fillColor; // Extract the fill color

                    // Check if the color matches any defined heading colors
                    for (const [heading, rgb] of Object.entries(headingColors)) {
                        if (colorsMatch(color, rgb) && !headingSet.has(text)) {
                            headingSet.add(text); // Add to set to avoid duplicates

                            const sectionItem = document.createElement('li');
                            sectionItem.textContent = text;
                            sectionItem.classList.add('section-item');
                            sectionItem.onclick = () => scrollToSection(text); // Implement the scrolling
                            sidebarList.appendChild(sectionItem);
                            break; // Exit the loop once we find a match
                        }
                    }
                });
            }
        }

        // Placeholder Function to Scroll to Sections (to be implemented)
        function scrollToSection(subtopic) {
            console.log(`Scroll to: ${subtopic}`);
            // Implement scrolling to the specified section here
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadPDF(); // Load the PDF
        });
    </script>
</head>
<body>
    <!-- Handbook Page Content -->
    <div class="container">
        <!-- Sidebar Section -->
        <div class="sidebar">
            <h2>Contents</h2>
            <ul id="sidebarList">
                <!-- Sections will be dynamically populated -->
            </ul>
        </div>

        <!-- PDF Viewer Section -->
        <div class="pdf-viewer-container" id="pdfViewerContainer">
            <!-- Individual canvases for each page will be added here -->
        </div>
    </div>
</body>
</html>
