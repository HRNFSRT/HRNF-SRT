<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handbook - Highrock National Forest Search & Rescue</title>
    
    <!-- Link to CSS Styles -->
    <link rel="stylesheet" href="styles.css">

    <!-- PDF.js Library from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

    <!-- Firebase Integration -->
    <script type="module">
        // Import Firebase functions from the CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js";
        import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.0/firebase-storage.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCz1kIH5hT_15pWT9rf5JqJhexK76qpRE",
            authDomain: "hrnf-srt.firebaseapp.com",
            projectId: "hrnf-srt",
            storageBucket: "hrnf-srt.appspot.com",
            messagingSenderId: "748926279394",
            appId: "1:748926279394:web:1303b9000361b1d51808bb",
            measurementId: "G-5PCZE3S5N5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); // Initialize Auth
        const storage = getStorage(app); // Initialize Storage

        // Load PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        // Load PDF from Firebase and render with PDF.js
        async function loadPDF() {
            try {
                const pdfRef = ref(storage, 'HRNF S&R Handbook V2 (1).pdf'); // Reference to the PDF
                const url = await getDownloadURL(pdfRef); // Get the download URL for the PDF
                const pdf = await pdfjsLib.getDocument(url).promise; // Load PDF document
                renderPDF(pdf); // Render the PDF
                const headings = await extractHeadingsFromPDF(pdf); // Extract headings
                buildSidebar(headings); // Build the sidebar with headings
            } catch (error) {
                console.error("Error loading PDF:", error);
            }
        }

        // Render the PDF using PDF.js
        async function renderPDF(pdf) {
            const pdfViewerContainer = document.getElementById('pdfViewerContainer');
            pdfViewerContainer.innerHTML = ''; // Clear the container before rendering

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 });

                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page';
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport,
                };
                await page.render(renderContext);
                pdfViewerContainer.appendChild(canvas); // Append the canvas to the viewer
            }
        }

        // Function to extract headings from the PDF
        async function extractHeadingsFromPDF(pdf) {
            const headings = [];
            const numPages = pdf.numPages;

            for (let i = 1; i <= numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();

                // Temporary array to hold headings for the current page
                const pageHeadings = [];

                textContent.items.forEach((item) => {
                    const text = item.str;
                    const fontSize = extractFontSize(item.transform);

                    // Check for specific conditions to identify headings
                    if (fontSize >= 14 && fontSize <= 18) { // Example font size range for headings
                        const level = getHeadingLevel(fontSize); // Determine the heading level based on font size
                        pageHeadings.push({ text, level });
                    }
                });

                // Push the headings from the current page to the main headings array
                headings.push(...pageHeadings);
            }
            return headings;
        }

        // Function to determine heading level based on font size
        function getHeadingLevel(fontSize) {
            if (fontSize === 18) return 1; // Heading 1
            if (fontSize === 16) return 2; // Heading 2
            if (fontSize === 14) return 3; // Heading 3
            return 0; // Not a heading
        }

        // Function to build the sidebar dynamically with nested structure
        function buildSidebar(headings) {
            const outlineView = document.getElementById('outlineView');
            const tree = createNestedStructure(headings);
            
            tree.forEach(item => {
                const listItem = createTreeItem(item);
                outlineView.appendChild(listItem);
            });
        }

        // Function to create a nested structure from the headings
        function createNestedStructure(headings) {
            const tree = [];
            const stack = [];

            headings.forEach(item => {
                const { text, level } = item;

                const node = { text, level, children: [] };

                // Adjust tree based on heading level
                if (level === 1) {
                    tree.push(node);
                    stack.length = 0; // Clear the stack for new top-level headings
                    stack.push(node);
                } else {
                    while (stack.length && stack[stack.length - 1].level >= level) {
                        stack.pop(); // Pop items from the stack until the right level is found
                    }
                    if (stack.length) {
                        stack[stack.length - 1].children.push(node);
                    }
                    stack.push(node); // Add current node to the stack
                }
            });

            return tree;
        }

        // Function to create a tree item element
        function createTreeItem(item) {
            const div = document.createElement('div');
            div.classList.add('treeItem');

            const link = document.createElement('a');
            link.href = `#section-${item.text.replace(/\s+/g, '-')}`; // Create a link based on the heading text
            link.textContent = item.text;

            // Add click event to scroll to section (to be implemented)
            link.onclick = (e) => {
                e.preventDefault();
                scrollToSection(`section-${item.text.replace(/\s+/g, '-')}`); // Call scroll to section
            };

            div.appendChild(link);

            // If the item has children, create a nested structure
            if (item.children.length > 0) {
                const childContainer = document.createElement('div');
                childContainer.classList.add('treeItems'); // Add a class for styling

                item.children.forEach(child => {
                    const childItem = createTreeItem(child);
                    childContainer.appendChild(childItem);
                });

                div.appendChild(childContainer); // Append child items to the parent
            }

            return div;
        }

        // Placeholder Function to Scroll to Sections (to be implemented)
        function scrollToSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadPDF(); // Load the PDF
        });
    </script>
</head>
<body>
    <!-- Handbook Page Content -->
    <div class="container">
        <!-- Sidebar Section -->
        <div class="sidebar">
            <h2>Contents</h2>
            <div id="sidebarContainer">
                <div id="outlineView" class="treeWithDeepNesting">
                    <!-- Headings will be dynamically populated -->
                </div>
            </div>
        </div>

        <!-- PDF Viewer Section -->
        <div class="pdf-viewer-container" id="pdfViewerContainer">
            <!-- Individual canvases for each page will be added here -->
        </div>
    </div>

    <!-- External CSS File -->
    <link rel="stylesheet" href="styles.css">

</body>
</html>
